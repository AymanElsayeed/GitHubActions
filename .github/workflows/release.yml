name: release.yml

on:
  push:
    branches:
      - "master"
  workflow_dispatch:
jobs:
  release:
    name: create release
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' &&
      github.ref == 'refs/heads/master' &&
      contains(github.event.head_commit.message, 'release')
    outputs:
      version: ${{ steps.extract_version.outputs.VERSION }}
    permissions:
      contents: write
    steps:
      - name: Extract Version
        id: extract_version
        uses: actions/github-script@v7
        with:
          script: |
            const msg = context.payload.head_commit?.message || '';
            console.log('Commit message:', msg);
            const match = msg.match(/release\s+(v\d+\.\d+\.\d+)/);
            if (!match) {
              core.setFailed('No release version found in commit message');
              return;
            }
            core.setOutput('VERSION', match[1]);
      - name: Sanitize Actor
        id: actor_sanitize
        run: |
          SANITIZED_ACTOR=$(echo "${{ github.actor }}" | tr -d '[]')
          echo "sanitized_actor=$SANITIZED_ACTOR" >> "$GITHUB_OUTPUT"
      - name: Check if tag already exists
        run: |
          git fetch --tags
          if git rev-parse "${{ steps.extract_version.outputs.VERSION }}" >/dev/null 2>&1; then
            echo "‚ùå Tag already exists: ${{ steps.extract_version.outputs.VERSION }}"
            exit 1
          fi

      - name: Create GitHub Release
        if: steps.extract_version.outputs.VERSION != ''
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.extract_version.outputs.VERSION }}
          name: Release ${{ steps.extract_version.outputs.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
