name: release.yml

on:
  push:
    branches:
      - "master"
  workflow_dispatch:
jobs:
  release:
    name: create release
    runs-on: ubuntu-latest
    if: (github.event_name == 'push' && github.ref == 'refs/heads/master')
    outputs:
      version: ${{ steps.extract_version.outputs.VERSION }}
    permissions:
      contents: write
    steps:
      - name: Extract Version
        id: extract_version
        uses: actions/github-script@v7
        with:
          script: |
            if (context.ref.startsWith('refs/tags/')) {
              const tag = context.ref.replace('refs/tags/', '');
              console.log('Using Version from Tag: ' + tag);
              core.setOutput('VERSION', tag);
              return;
            }

            let msg = '';
            if (context.eventName === 'pull_request' && context.payload.pull_request) {
              msg = context.payload.pull_request.title;
              console.log('Checking PR Title: ' + msg);
            } else {
              msg = context.payload.head_commit?.message || '';
              console.log('Checking Commit Message: ' + msg);
            }
            // Try to extract "release vX.Y.Z" from commit message or PR title
            const match = msg.match(/release\s+(v?\d+\.\d+\.\d+)/);
            if (match && match[1]) {
              console.log('Found Explicit Version: ' + match[1]);
              core.setOutput('VERSION', match[1]);
            } else {
              // Fallback: Auto-generate version if none found
              const fallbackVersion = `v1.0.${context.runNumber}`;
              console.log('No version found in message, using fallback: ' + fallbackVersion);
              core.setOutput('VERSION', fallbackVersion);
            }
      - name: Sanitize Actor
        id: actor_sanitize
        run: |
          SANITIZED_ACTOR=$(echo "${{ github.actor }}" | tr -d '[]')
          echo "sanitized_actor=$SANITIZED_ACTOR" >> "$GITHUB_OUTPUT"
      - name: Create GitHub Release
        if: steps.extract_version.outputs.VERSION != ''
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.extract_version.outputs.VERSION }}
          name: Release ${{ steps.extract_version.outputs.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
