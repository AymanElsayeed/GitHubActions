name: release.yml
on:
  pull_request:
    types: [closed]
    branches: ["master"]
  workflow_dispatch:
jobs:
  release:
    name: create release
    runs-on: ubuntu-latest
    if: |
          github.event.pull_request.merged == true &&
          contains(github.event.pull_request.title, 'release')
    outputs:
      version: ${{ steps.extract_version.outputs.VERSION }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Extract Version
        id: extract_version
        uses: actions/github-script@v7
        with:
          script: |
            const msg = context.payload.pull_request.title || '';
            console.log('Commit message:', msg);
            const match = msg.match(/release\s+(v\d+\.\d+\.\d+)/);
            if (!match) {
              core.setFailed('No release version found in commit message');
              return;
            }
            core.setOutput('VERSION', match[1]);
      - name: Sanitize Actor
        id: actor_sanitize
        run: |
          SANITIZED_ACTOR=$(echo "${{ github.actor }}" | tr -d '[]')
          echo "sanitized_actor=$SANITIZED_ACTOR" >> "$GITHUB_OUTPUT"

      - name: Check if tag already exists
        run: |
          git fetch --tags
          if git rev-parse "${{ steps.extract_version.outputs.VERSION }}" >/dev/null 2>&1; then
            echo "‚ùå Tag already exists: ${{ steps.extract_version.outputs.VERSION }}"
            exit 1
          fi

      - name: Create GitHub Release
        if: steps.extract_version.outputs.VERSION != ''
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.extract_version.outputs.VERSION }}
          name: Release ${{ steps.extract_version.outputs.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
